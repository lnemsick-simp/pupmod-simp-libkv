# <%= value[:description] %>
#
# @author https://github.com/simp/pupmod-simp-libkv/graphs/contributors
#
Puppet::Functions.create_function(:'libkv::<%= function %>') do

<% full_hash_spec = value[:signatures]['full_hash'] -%>
<% unless full_hash_spec[:args].nil? -%>
<%   full_hash_spec[:args].each do |argument| -%>
<%     if value[:allow_empty] -%>
  # @param <%= argument[:name] %> Hash containing provider configuration
<%     else -%>
  # @param <%= argument[:name] %> Hash containing required <%= function %> parameters
  #   and provider configuration:
  #   <%= argument[:description].split("\n").join("\n  #  ") %>
<%     end -%>
<%   end -%>
<% end -%>
  #
  # @return [<%= value[:retval][:type] %>] <%= value[:retval][:description] %>
  #
  # @raise [RuntimeError] if Ruby files needed for libkv operation cannot
  # be found (e.g., unknown libkv provider specified)
  #
  # @raise [SyntaxError] if any libkv provider (Ruby) files fail to parse
  #
  dispatch :<%= function %> do
    param 'Hash', :parameters
  end
<% if value[:allow_empty] -%>

  # @return [<%= value[:retval][:type] %>] <%= value[:retval][:description] %>
  #
  dispatch :<%= function + '_empty' %> do
  end

  def <%= function + '_empty' %>
     self.<%= function %>({})
  end
<% end -%>
<% unless value[:signatures].nil? -%>
<%   value[:signatures].each do |key, spec| -%>
<%     next if key == 'full_hash' -%>

<%     unless spec[:args].nil? -%>
<%       spec[:args].each do |argument| -%>
  # @param <%= argument[:name] %> <%= argument[:description] %>
<%       end -%>
<%     end -%>
  #
  # @return [<%= value[:retval][:type] %>] <%= value[:retval][:description] %>
  #
  # @raise [RuntimeError] if Ruby files needed for libkv operation cannot
  # be found (e.g., unknown libkv provider specified)
  #
  # @raise [SyntaxError] if any libkv provider (Ruby) files fail to parse
  #
  dispatch :<%= function + '_' + key %> do
<%     unless spec[:args].nil? -%>
<%       spec[:args].each do |argument| -%>
    param '<%= argument[:type] %>', :<%= argument[:name] %>
<%       end -%>
<%     end -%>
  end

<%     unless spec[:args].nil?
#FIXME should be able to do this in a map operation
          array = []
          spec[:args].each do |argument|
            array << argument[:name]
          end
          args = array.join(', ')
       end -%>
  def <%= function + '_' + key %>(<%= args -%>)
    params = {}
<%     unless spec[:args].nil? -%>
<%       spec[:args].each do |argument| -%>
    <%= "params['" + argument[:name] + "'] = " + argument[:name] %>
<%       end -%>
<%     end -%>

    <%= function%>(params)
  end
<%   end -%>
<% end -%>

  def <%= function %>(params)
<% unless value[:allow_empty] -%>
    # ensure all required parameters are present
    validate_params(params)
<% end -%>

    # add defaults for global, optional parameters
    nparams = update_params(params)

    # add libkv 'extension' to the catalog instance as needed
    catalog = closure_scope.find_global_scope.catalog
    unless catalog.respond_to?(:libkv)
      lib_dir = File.dirname(File.dirname(File.dirname(File.dirname("#{__FILE__}"))))
      filename = File.join(lib_dir, 'puppet_x', 'libkv', 'loader.rb')
      if File.exists?(filename)
        catalog.instance_eval(File.read(filename), filename)
      else
        raise("Internal error: libkv::<%= function %> unable to load #{filename}: File not found")
      end
    end

    unless catalog.libkv.provider?(params['provider'])
      raise("ERROR: libkv::<%= function %> - Unknown libkv provider '#{params['provider']}'")
    end

    # use libkv for <%= function %> operation
    retval = nil
    begin
      retval = catalog.libkv.<%= function %>(nparams['url'], nparams['auth'], nparams);
    rescue Exception => e
      if nparams['softfail']
        retval =  <%= value[:softfail_value] %>
      else
        raise(e)
      end
    end

    return retval;
  end

  # Add defaults for missing, optional parameters and Puppet info
  #
  # @param input parameters (read-only)
  # @return copy of params that has been updated
  def update_params(params)
    nparams = params.dup

    # determine libkv provider, url and auth parameters to use
    unless nparams.key?('provider')
      nparams['provider'] = call_function('lookup', 'libkv::provider', { 'default_value' => 'mock' })
    end

    unless nparams.key?('url')
      nparams['url'] = call_function('lookup', 'libkv::url', { 'default_value' => 'mock://' })
    end

    unless nparams.key?('auth')
      nparams['auth'] = call_function('lookup', 'libkv::auth', { 'default_value' => nil })
    end

    # add Puppet info to params
    unless nparams.key?('environment')
      nparams['environment'] = closure_scope.lookupvar('::environment')
    end

    unless nparams.key?('user')
      nparams['user'] = Puppet.settings[:user] ? Puppet.settings[:user] : 'puppet'
    end

    unless nparams.key?('group')
      nparams['group'] = Puppet.settings[:group] ? Puppet.settings[:group] : 'group'
    end

    unless nparams.key?('puppet_vardir')
      nparams['group'] = Puppet.settings[:vardir] ? Puppet.settings[:vardir] : 'vardir'
    end

    nparams
  end


<% unless value[:allow_empty] || !value[:validations].empty? -%>
  # check for required parameters
  # @param input parameters
  # @raise ArgumentError if any required parameters are missing or invalid
  def validate_params(params)

<% unless value[:allow_empty] -%>
<% end -%>


  end
end
